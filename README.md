# Сервис CLOUD
Дипломная работа «Облачное хранилище» (серверное Java SpringBoot бэкенд приложение)

## Общее назначение Сервиса
1. Хранение Пользователями файлов в "Облаке" (на удаленном сервере)
2. Просмотр сохраненных файлов в Облаке
3. Загрузка файлов с локального компьютера в Облако
4. Скачивание файлов из Облака на локальный компьютер
5. Изменение имен файлов в Облаке
6. Удаление файлов из Облака
7. Доступ к Облаку (аутентификация) осуществляется с помощью пользовательского Логина / Пароля
8. Управление файлами (авторизация) осуществляется на основе Полномочий (права: см. пп.2-6 выше)

## Запуск и использование сервера Сервиса
1. Старт бэк-сервиса (в простейшем варианте) выполняется командой Run->Run->CloudApp из меню IDE IJ IDEA
2. Запуск бэк-сервиса требует наличие запущенного, на локальном ПК приложения Docker, в котором создается Контейнер для работы Базы Данных
3. При необходимости, можно запустить в Контейнерах и БД, и Бэк-сервис (см. файл ./compose.yaml)
4. Успешный старт бэк-сервиса определяется наличием в логе записи "Started CloudApp in SS.MMM seconds" и "==> CloudApp started"

## Запуск и использование внешнего UI / Frontend для взаимодействия с Сервисом 
1. Структура проекта содержит директорию ./frontend c описанием запуска Фронта в файле ./frontend/README.md
2. Старт фронт-сервиса выполняется командой ./frontend/npm run serve (выполнены настройки client-server взаимодействия)
3. Доступ к Фронту выполняется через браузер по адресу http://localhost:8080/
4. Фронт позволяет проводить логин, логаут, просмотр, загрузку, переименование, удаление файлов с Облаке

## Детальное описание возможностей Сервиса

### Безопасность
1. Вход в "Облако" - аутентификация Пользователя с помощью Логина / Пароля
   - Хранение аутентификационных данных (Токена) без необходимости повторного ввода Логина / Пароля
   - Запрос POST http://localhost:8080/login
2. Выход из "Облака" - завершение аутентификационной сессии
   - Удаление Токена с последующей необходимостью повторного ввода логина / пароля
   - Запрос POST http://localhost:8080/logout
3. Авторизация Пользователей посредством использования Ролей и Полномочий:
   - Полномочия:
     - AUTHORITY_NONE = отсутствие любых полномочий
     - AUTHORITY_LOGIN = только возможность аутентификации без иных полномочий
     - AUTHORITY_VIEW = возможность просмотра Пользователем файлов в "Облачном хранилище"
     - AUTHORITY_READ = возможность скачивания Пользователем файлов в "Облачном хранилище"
     - AUTHORITY_WRITE = возможность загрузки Пользователем файлов в "Облачное хранилище"
     - AUTHORITY_DELETE = возможность просмотра Пользователем файлов в "Облачном хранилище"
   - Роли:
     - ROLE_GUEST =  полномочие AUTHORITY_LOGIN
     - ROLE_VIEWER = роль ROLE_GUEST + полномочие AUTHORITY_VIEW
     - ROLE_READER = роль ROLE_VIEWER + полномочие AUTHORITY_READ
     - ROLE_WRITER = роль ROLE_READER + полномочие AUTHORITY_WRITE
     - ROLE_MASTER = роль ROLE_WRITER + полномочие AUTHORITY_DELETE
4. По умолчанию, в Базе Данных Пользователей Сервиса, присутствуют следующие Пользователи:
   - Гость:
     - логин = g@m.ru, пароль = pwd, роль = ROLE_GUEST
   - Наблюдатель:
     - логин = v@m.ru, пароль = pwd, роль = ROLE_VIEWER
   - Выгрузчик:
     - логин = r@m.ru, пароль = pwd, роль = ROLE_READER
   - Загрузчик:
     - логин = w@m.ru, пароль = pwd, роль = ROLE_WRITER
   - Администратор:
     - логин = m@m.ru, пароль = , роль = ROLE_MASTER

### Работа с файлами
1. Функции и операции работы с файлами в "Облачном хранилище"
   - Просмотр списка файлов, запрос:
     - POST http://localhost:8080/list?limit=3
   - Скачивание файла, запрос:
     - GET http://localhost:8080/file?filename=my_picture.jpg
   - Загрузка файла, запрос:
     - POST http://localhost:8080/file?filename=my_picture.jpg
   - Переименование файла, запрос:
     - PUT http://localhost:8080/file?filename=my_picture.jpg
   - Удаление файла, запрос:
     - DELETE http://localhost:8080/file?filename=my_picture.jpg
2. Внутреннее хранение файлов
   - файлы хранятся на файловой системе сервиса (с возможностью указания места хранения)
   - хранение файлов в Базе Данных сервиса: при необходимости, такая доработка возможна

### Обработка ошибок
   - Ошибка аутентификации: UserNotAuthorizedException
   - Ошибка наличия токена: TokenNotFoundException
   - Ошибка наличия описания файла в Каталоге Файлов: FileNotFoundInDatabaseException
   - Ошибка наличия физического файла в Файловом Хранилище: FileNotFoundOnDiskException
   - Ошибка загрузки файла из-за его наличия в Файловом Хранилище: FileAlreadyExistsOnDiskException
   - Внутренняя ошибка сервера при операциях с файлами: FileInternalServerException
   - Ошибка валидации при процессинге запросов / данных: ConstraintViolationException

### Журналирование
   - Использование встроенной функции logback (Spring) с выводом детальных логов в консоль
   - Расширенное логирование входящих REST-запросов при помощи компонента LoggingInterceptorRest (HandlerInterceptor.preHandle) 



---
# Дипломная работа «Облачное хранилище»
Оригинальное описание задания
## Описание проекта
Задача — разработать REST-сервис. Сервис должен предоставить REST-интерфейс для загрузки файлов и вывода списка уже загруженных файлов пользователя.

Все запросы к сервису должны быть авторизованы. Заранее подготовленное веб-приложение (FRONT) должно подключаться к разработанному сервису без доработок,
а также использовать функционал FRONT для авторизации, загрузки и вывода списка файлов пользователя.

## Требования к приложению

- Сервис должен предоставлять REST-интерфейс для интеграции с FRONT.
- Сервис должен реализовывать все методы, описанные в [yaml-файле](./CloudServiceSpecification.yaml):
    1. Вывод списка файлов.
    2. Добавление файла.
    3. Удаление файла.
    4. Авторизация.
- Все настройки должны вычитываться из файла настроек (yml).
- Информация о пользователях сервиса (логины для авторизации) и данные должны храниться в базе данных (на выбор студента).

## Требования к реализации

- Приложение разработано с использованием Spring Boot.
- Использован сборщик пакетов gradle/maven.
- Для запуска используется docker, docker-compose.
- Код размещён на Github.
- Код покрыт unit-тестами с использованием mockito.
- Добавлены интеграционные тесты с использованием testcontainers.

## Шаги реализации

- Изучите протокол получения и отправки сообщений между FRONT и BACKEND.
- Нарисуйте схему приложений.
- Опишите архитектуру приложения, где хранятся настройки и большие файлы, структуры таблиц/коллекций базы данных.
- Создайте репозиторий проекта на Github.
- Напишите приложение с использованием Spring Boot.
- Протестируйте приложение с помощью curl/postman.
- Протестируйте приложение с FRONT.
- Напишите README.md к проекту.
- Отправьте на проверку.

## Описание и запуск FRONT

1. Установите nodejs (версия не ниже 19.7.0) на компьютер, следуя [инструкции](https://nodejs.org/ru/download/current/).
2. Скачайте [FRONT](./netology-diplom-frontend) (JavaScript).
3. Перейдите в папку FRONT приложения и все команды для запуска выполняйте из неё.
4. Следуя описанию README.md FRONT проекта, запустите nodejs-приложение (`npm install`, `npm run serve`).
5. Далее нужно задать url для вызова своего backend-сервиса.
    1. В файле `.env` FRONT (находится в корне проекта) приложения нужно изменить url до backend, например: `VUE_APP_BASE_URL=http://localhost:8080`.
        1. Нужно указать корневой url вашего backend, к нему frontend будет добавлять все пути согласно спецификации
        2. Для `VUE_APP_BASE_URL=http://localhost:8080` при выполнении логина frontend вызовет `http://localhost:8080/login`
    2. Запустите FRONT снова: `npm run serve`.
    3. Изменённый `url` сохранится для следующих запусков.
6. По умолчанию FRONT запускается на порту 8080 и доступен по url в браузере `http://localhost:8080`.
    1. Если порт 8080 занят, FRONT займёт следующий доступный (`8081`). После выполнения `npm run serve` в терминале вы увидите, на каком порту он запустился.

## Авторизация приложения

FRONT-приложение использует header `auth-token`, в котором отправляет токен (ключ-строка) для идентификации пользователя на BACKEND.
Для получения токена нужно пройти авторизацию на BACKEND и отправить на метод /login логин и пароль. В случае успешной проверки в ответ BACKEND должен вернуть json-объект
с полем `auth-token` и значением токена. Все дальейшие запросы с FRONTEND, кроме метода /login, отправляются с этим header.
Для выхода из приложения нужно вызвать метод BACKEND /logout, который удалит/деактивирует токен. Последующие запросы с этим токеном будут не авторизованы и вернут код 401.

Обратите внимание, что название самого параметра (как и всех параметров в спецификации), его регистр имеют значение.
Важно, чтобы ваш backend возвращал токен в поле `auth-token` – если поле будет называться `authToken` или `authtoken`, фронт не сможет найти токен и дальше логина процесс не пройдёт.

## Настройка CORS

Чтобы FRONT смог обратиться к вашему серверу, необходимо настроить CORS в вашем приложении. Например, можно сделать это, добавив конфигурацию:
```java
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.CorsRegistry;
import org.springframework.web.servlet.config.annotation.EnableWebMvc;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
@EnableWebMvc
class WebConfig implements WebMvcConfigurer {

    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**")
            .allowCredentials(true)
            .allowedOrigins("http://localhost:8081")
            .allowedMethods("*");
    }
}
```
где адрес в параметре `allowedOrigins` – это адрес фронта.

## Дополнительные рекомендации

Это итоговый проект, где вы будете использовать все полученные вами знания не только в написании кода, но и в поиске информации, в траблшутинге и т.д.
Используйте все доступные вам инструменты, чтобы решить возникающие проблемы:
1) Используйте консоль разработчика в браузере, вкладка Network. Она позволит вам увидеть, какой запрос отправляет фронт, какие параметры и url он использует, какой ответ он получает.
2) Используйте дебаг в IDEA, чтобы увидеть весь процесс обработки запроса вашим приложением.
3) Используйте интернет для поиска стандартных подходов, гайдов, распространённых ошибок. Все проблемы уже были решены до нас.
____________


### Если возникли вопросы

- Попробуйте найти ответ в лекциях, материалах и домашних заданиях курса. После этого воспользуйтесь Google. В случае любой сложности вы можете задать вопрос дипломному руководителю. Но лучше сначала попытаться решить проблему самостоятельно.
- В одном вопросе лучше описывать одну проблему. Так ответ дипломного руководителя будет максимально эффективным и полезным.
- По возможности прикрепляйте к вопросу скриншоты и стрелочкой показывайте, где не получается. Программу для этого можно скачать [здесь](https://app.prntscr.com/ru/).
- По возможности задавайте вопросы в комментариях к коду.
- Начинайте работу над дипломом как можно раньше, чтобы было больше времени на правки.
- Делайте диплом по частям, а не всё сразу. Так вы сможете оперативно внести правки, и не придётся переделывать большую часть работы. 